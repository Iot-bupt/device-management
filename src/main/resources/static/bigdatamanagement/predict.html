<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>大数据平台-数据预测</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-table.css" rel="stylesheet">
    <link href="css/bootstrap-select.css" rel="stylesheet">

    <style>
        .abc:hover {
            color: black !important;
        }
        .abc0:hover{
            background-color: #337ab7 !important;
        }

    </style>
</head>
<body style="padding-top: 50px;height: 100%">

<nav class="navbar navbar-fixed-top" style="background-color: #337ab7">

    <div class="navbar-header" style="margin-left: 10px">
        <a class="navbar-brand" href="#" style="color: white">大数据平台</a>
    </div>
    <div class="navbar-collapse">
        <!--<ul class="nav navbar-nav">
            <li><a href="/userformPage.do"  class="abc0"style="color: #faf2cc">用户管理</a></li>
            <li class="dropdown">
                <a href="#" class="abc" style="color: white" data-toggle="dropdown">我的网盘<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="/uploadPage.do">springmvc</a></li>
                    <li><a href="#">springsecurity</a></li>
                    <li><a href="#">spring</a></li>
                    <li class="divider"></li>
                    <li class="dropdown-header">DAO</li>
                    <li><a href="#">mybatis</a></li>
                    <li><a href="#">hibenate</a></li>
                </ul>
            </li>
        </ul>-->
        <ul class="navbar-right navbar-form">
            <!--<div class="form-group">
                <input type="text" placeholder="Email" class="form-control">
            </div>-->
            <a href="/home?TENANT_ADMIN&2&1"><button id="logout" type="submit" class="btn btn-primary" style="margin-right: 40px">返回上一级</button></a>
        </ul>
    </div><!--/.nav-collapse -->

</nav>

<div class="row" style="height: 100%">
    <div class="col-md-2" style="box-shadow: 1px 1px 3px #e5e5e5;height: 1400px;width: 13%">
        <ul id="main-nav" class="nav nav-stacked" style="">
            <li>
                <a href="../bigData/device1.html">
                    <i class="glyphicon glyphicon-th-large">&nbsp;</i>
                    数据管理
                </a>
            </li>
            <li>
                <a href="sql.html">
                    <i class="glyphicon glyphicon-search">&nbsp;</i>
                    SQL查询
                </a>
            </li>
            <li>
                <a href="#systemSetting" class="nav-header collapsed" data-toggle="collapse">
                    <i class="glyphicon glyphicon-stats">&nbsp;</i>
                    数据分析
                    <!--<span class="pull-right glyphicon glyphicon-chevron-down"></span>-->
                    <span class="label label-warning pull-right">2</span>
                </a>
                <ul id="systemSetting" class="nav nav-list collapse secondmenu" style="height: 0px;border-bottom: 1px silver dotted">
                    <li><a href="../bigData/ocean.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 整体分析</a></li>
                    <li><a href="../bigData/statistics1.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 按类分析</a></li>
                    <!--<li><a href="#"><i class="glyphicon glyphicon-edit">&nbsp;</i> 修改密码</a></li>
                    <li><a href="#"><i class="glyphicon glyphicon-eye-open">&nbsp;</i> 日志查看</a></li>-->
                </ul>
            </li>
            <li>
                <a href="etl.html">
                    <i class="glyphicon glyphicon-cog">&nbsp;</i>
                    数据ETL
                </a>
            </li>
            <li>
                <a href="#systemSetting1" id="drop1" class="nav-header collapsed" data-toggle="collapse">
                    <i class="glyphicon glyphicon-eye-open">&nbsp;</i>
                    数据预测
                    <!--<span class="pull-right glyphicon glyphicon-chevron-down"></span>-->
                    <span class="label label-warning pull-right">2</span>
                </a>
                <ul id="systemSetting1" class="nav nav-list collapse secondmenu" style="height: 0px;border-bottom: 1px silver dotted">
                    <li class="active" style="background-color: #eeeeee"><a href="predict.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 任务管理</a></li>
                    <li><a href="model.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 模型管理</a></li>
                </ul>
            </li>
            <li>
                <a href="datadig.html">
                    <i class="glyphicon glyphicon-leaf">&nbsp;</i>
                    数据挖掘
                </a>
            </li>
            <li>
                <a onclick="online()">
                    <i class="glyphicon glyphicon-cloud">&nbsp;</i>
                    线上开发
                </a>
            </li>
        </ul>
    </div>

    <div class="col-md-10">
        <div class="container"  style="padding: 30px 15px">

            <div class="panel panel-primary" style="margin-top: 1%">
                <div class="panel-heading" style="text-align: center">
                    <h3 class="panel-title">预测任务管理</h3>
                </div>
                <div id="toolbar">
                    <button id="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">创建新应用</button>
                </div>
                <div class="panel panel-body">
                    <div id="divtable"></div>
                </div>
            </div>
            <!--<fieldset style="border:none;border-top:1px solid #cec9c9;margin:30px 0 20px;">
                <legend style="font-size: 20px;font-weight: 300;padding: 0 10px;margin-left: 20px">查询结果</legend>
            </fieldset>-->
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">创建新应用</h4>
                </div>
                <div class="modal-body">
                    <div style="margin-left: 3%">
                        填写应用名称：&nbsp;&nbsp;&nbsp;<input id="modal4" class="form-control" placeholder="填写应用名称" type="text" autofocus style="width: 220px;display: inline"><br><br>
                        选择模型：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id="modal2" class="selectpicker" data-live-search="true" data-live-search-placeholder="搜索" title="选择模型"></select><br><br><br>
                        <div id="div1">选择数据源：<br><br></div><br>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button id="modalsubmit" type="button" class="btn btn-primary" data-dismiss="modal">提交更改</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

</div>

<script src="js/jquery-3.3.1.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/bootstrap-table.js"></script>
<script src="js/bootstrap-table-zh-CN.js"></script>
<script src="js/bootstrap-select.js"></script>
<script type="text/javascript">

    var deviceGroup = [];
    var modelIdGroup = [];

    $.get("/api/device/alldevices?limit=100",function (data) {
        deviceGroup = data;
        $div1 = $("#div1");
        for (var j=0; j<deviceGroup.length; j++) {
            $checkbox = $("<label style='margin-left: 4%'><input class='merge' value="+deviceGroup[j].name+" type=\"checkbox\"/>&nbsp;"+deviceGroup[j].name+" </label> ");
            $div1.append($checkbox);
        }
    });

    $.get("http://39.104.186.210:8092/api/model/get-model-id?tenantId=1",function (data) {
        $select = $("#modal2");
        modelIdGroup = data;
        for (var i=0; i<data.data.length; i++) {
            $option = $("<option>"+data.data[i].model_name+"</option>");
            $select.append($option);
        }
        $select.selectpicker("refresh");
    });

    $("#drop1").trigger("click");
    $.get("http://39.104.186.210:8092/api/app/get-app",function (data) {
        $("#divtable").append($("<table id=\"realTime_Table\">\n" +
            "                            <thead id=\"thead\" style=\"text-align: center\">\n" +
            "                                <tr>\n" +
            "                                    <th>应用名称</th>\n" +
            "                                    <th>应用id</th>\n" +
            "                                    <th data-field=\"model\" data-sortable=\"true\">所属模型id</th>\n" +
            "                                    <th>数据源</th>\n" +
            "                                    <th>租户id</th>\n" +
            "                                    <th>操作</th>\n" +
            "                                </tr>\n" +
            "                            </thead>\n" +
            "                            <tbody id=\"tbody\" style=\"text-align: center\"></tbody>\n" +
            "                        </table>"));
        for (var i=0; i<data.data.length; i++) {
            $tr = $("<tr></tr>");
            $td1 = $("<td>"+data.data[i].app_name+"</td>");
            $td2 = $("<td>"+data.data[i].app_id+"</td>");
            $td3 = $("<td>"+data.data[i].model_id+"</td>");
            var a = "";
            for (var j=0; j<data.data[i].app_input.length; j++){
                if (j != data.data[i].app_input.length-1) {
                    a = a + "设备id:"+data.data[i].app_input[j].device_id+" 属性:"+data.data[i].app_input[j].type + ",";
                }else {
                    a = a + "设备id:"+data.data[i].app_input[j].device_id+" 属性:"+data.data[i].app_input[j].type;
                }
            }
            $td4 = $("<td>"+a+"</td>");
            $td5 = $("<td>"+data.data[i].tenant_id+"</td>");
            $td6 = $("<td></td>");
            $button1 = $("<button type='button' onclick='button1(this)' class='btn-xs btn-danger'>删除</button>");
            $button2 = $("<button type='button' onclick='button2(this)' class='btn-xs btn-success'>启动</button>");
            $button3 = $("<button type='button' onclick='button3(this)' class='btn-xs btn-warning'>停止</button>");
            $button4 = $("<button type='button' onclick='button4(this)' class='btn-xs btn-info'>结果</button>");
            $td6.append($button1);
            $td6.append($button2);
            $td6.append($button3);
            $td6.append($button4);
            $tr.append($td1);
            $tr.append($td2);
            $tr.append($td3);
            $tr.append($td4);
            $tr.append($td5);
            $tr.append($td6);
            $("#tbody").append($tr);
        }
        $("#realTime_Table").bootstrapTable({
            search: true,
            pagination: true,
            pageSize: 10,
            pageList: [5, 10, 15, 20, 50, 100],
            locale: "zh-CN",
            striped: true,
            showColumns: true,
            sortable: true,
            sortName: "model",
            toolbar: "#toolbar"
        });
    });

    $("#modalsubmit").click(
        function () {
            var modelName = $("#modal2").val();
            var modelId;
            for (var j=0; j<modelIdGroup.data.length; j++) {
                if (modelName == modelIdGroup.data[j].model_name) {
                    modelId = modelIdGroup.data[j].model_id;
                }
            }
            var dataSource = [];
            var appName = $("#modal4").val();
            $("#div1").find("input[type=checkbox]:checked").each(
                function () {
                    for (var i=0; i<deviceGroup.length; i++) {
                        if (deviceGroup[i].name == $(this).val()) {
                            dataSource.push('"'+deviceGroup[i].id+'"');
                        }
                    }
                }
            );
            var url = "http://39.104.186.210:8092/api/app/create-app?tenantId=1&modelId="+modelId+"&dataSource=["+dataSource+"]&appName="+appName;
            $.get(url,function (data) {
                alert(JSON.stringify(data));
                window.location.href = "predict.html";
            })
        }
    );

    function button1(dom) {
        $.get("http://39.104.186.210:8092/api/app/delete-app?appId="+$(dom).parent().parent().children().eq(1).html(),function (data) {
            window.alert(JSON.stringify(data));
            window.location.href = "predict.html";
        })
    }

    function button2(dom) {
        $.get("http://39.104.186.210:8092/api/app/start-app?appId="+$(dom).parent().parent().children().eq(1).html(),function (data) {
            window.alert(JSON.stringify(data));
            window.location.href = "predict.html";
        })
    }

    function button3(dom) {
        $.get("http://39.104.186.210:8092/api/app/stop-app?appId="+$(dom).parent().parent().children().eq(1).html(),function (data) {
            window.alert(JSON.stringify(data));
            window.location.href = "predict.html";
        })
    }

    function button4(dom) {
        $.get("http://39.104.186.210:8092/api/app/real-predict?appId="+$(dom).parent().parent().children().eq(1).html(),function (data) {
            window.alert(JSON.stringify(data));
            window.location.href = "predict.html";
        })
    }

    function online() {
        window.open("http://39.104.186.210:8888");
    }

</script>
</body>
</html>