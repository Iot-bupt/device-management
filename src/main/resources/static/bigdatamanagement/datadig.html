<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>大数据平台-数据挖掘</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-table.css" rel="stylesheet">
    <link href="css/bootstrap-select.css" rel="stylesheet">

    <style>
        .abc:hover {
            color: black !important;
        }
        .abc0:hover{
            background-color: #337ab7 !important;
        }

    </style>
</head>
<body style="padding-top: 50px;height: 100%">

<nav class="navbar navbar-fixed-top" style="background-color: #337ab7">

    <div class="navbar-header" style="margin-left: 10px">
        <a class="navbar-brand" href="#" style="color: white">大数据平台</a>
    </div>
    <div class="navbar-collapse">
        <!--<ul class="nav navbar-nav">
            <li><a href="/userformPage.do"  class="abc0"style="color: #faf2cc">用户管理</a></li>
            <li class="dropdown">
                <a href="#" class="abc" style="color: white" data-toggle="dropdown">我的网盘<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="/uploadPage.do">springmvc</a></li>
                    <li><a href="#">springsecurity</a></li>
                    <li><a href="#">spring</a></li>
                    <li class="divider"></li>
                    <li class="dropdown-header">DAO</li>
                    <li><a href="#">mybatis</a></li>
                    <li><a href="#">hibenate</a></li>
                </ul>
            </li>
        </ul>-->
        <ul class="navbar-right navbar-form">
            <!--<div class="form-group">
                <input type="text" placeholder="Email" class="form-control">
            </div>-->
            <!--<a href="/home?TENANT_ADMIN&2&1"><button id="logout" type="submit" class="btn btn-primary" style="margin-right: 40px">返回上一级</button></a>-->
        </ul>
    </div><!--/.nav-collapse -->

</nav>

<div class="row" style="height: 100%">
    <div class="col-md-2" style="box-shadow: 1px 1px 3px #e5e5e5;height: 1400px;width: 13%">
        <ul id="main-nav" class="nav nav-stacked" style="">
            <li>
                <a href="#" onclick="dashboard1()">
                    <i class="glyphicon glyphicon-home">&nbsp;</i>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="../bigData/device2.html">
                    <i class="glyphicon glyphicon-th-large">&nbsp;</i>
                    数据管理
                </a>
            </li>
            <li>
                <a href="sql.html">
                    <i class="glyphicon glyphicon-search">&nbsp;</i>
                    SQL查询
                </a>
            </li>
            <li>
                <a href="#systemSetting" class="nav-header collapsed" data-toggle="collapse">
                    <i class="glyphicon glyphicon-stats">&nbsp;</i>
                    数据分析
                    <!--<span class="pull-right glyphicon glyphicon-chevron-down"></span>-->
                    <span class="label label-warning pull-right">2</span>
                </a>
                <ul id="systemSetting" class="nav nav-list collapse secondmenu" style="height: 0px;border-bottom: 1px silver dotted">
                    <li><a href="../bigData/ocean.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 整体分析</a></li>
                    <li><a href="../bigData/statistics1.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 按类分析</a></li>
                    <!--<li><a href="#"><i class="glyphicon glyphicon-edit">&nbsp;</i> 修改密码</a></li>
                    <li><a href="#"><i class="glyphicon glyphicon-eye-open">&nbsp;</i> 日志查看</a></li>-->
                </ul>
            </li>
            <li>
                <a href="etl.html">
                    <i class="glyphicon glyphicon-cog">&nbsp;</i>
                    数据ETL
                </a>
            </li>
            <li>
                <a href="#systemSetting1" class="nav-header collapsed" data-toggle="collapse">
                    <i class="glyphicon glyphicon-eye-open">&nbsp;</i>
                    数据预测
                    <!--<span class="pull-right glyphicon glyphicon-chevron-down"></span>-->
                    <span class="label label-warning pull-right">3</span>
                </a>
                <ul id="systemSetting1" class="nav nav-list collapse secondmenu" style="height: 0px;border-bottom: 1px silver dotted">
                    <li><a href="predict.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 任务管理</a></li>
                    <li><a href="model.html"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 模型管理</a></li>
                    <li><a href="#" onclick="result2()"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>- 预测性维护</a></li>
                </ul>
            </li>
            <li class="active" style="background-color: #eeeeee">
                <a href="datadig.html">
                    <i class="glyphicon glyphicon-leaf">&nbsp;</i>
                    数据挖掘
                </a>
            </li>
            <li>
                <a onclick="online()">
                    <i class="glyphicon glyphicon-cloud">&nbsp;</i>
                    线上开发
                </a>
            </li>
        </ul>
    </div>

    <div class="col-md-10">
        <div class="container"  style="padding: 30px 15px">
            <div class="panel panel-primary" style="margin-top: 1%">
                <div class="panel-heading" style="text-align: center">
                    <h3 class="panel-title">数据聚类</h3>
                </div>
                <div class="panel panel-body">
                    <div id="divtable" class="panel-body" style="text-align: center">
                        <div id="toolbar">
                            <button id="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">自定义聚类分析</button>
                        </div>
                        <table id="realTime_Table">
                            <thead id="thead"></thead>
                            <tbody id="tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="panel panel-primary" style="margin-top: 1%">
                <div class="panel-heading" style="text-align: center">
                    <h3 class="panel-title">处理过程（仅限二维）</h3>
                </div>
                <div class="panel panel-body">
                    <div id="map" style="width: 100%;height: 600px;float: left;margin-top: 1%; background: transparent"></div>
                </div>
            </div>

            <!--<fieldset style="border:none;border-top:1px solid #cec9c9;margin:30px 0 20px;">
                <legend style="font-size: 20px;font-weight: 300;padding: 0 10px;margin-left: 20px">查询结果</legend>
            </fieldset>-->

            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel" data-toggle="modal" data-target="#myModal">自定义聚类分析</h4>
                        </div>
                        <div class="modal-body">
                            <div id="divmodal" style="margin-left: 5%">
                                <div id="div1">源表：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id="modal1" class="selectpicker" data-live-search="true" data-live-search-placeholder="选择源表" title="选择源表"></select><br><br></div>
                                <div id="div2"></div>
                                类别个数：&nbsp;&nbsp;<input id="modal3" class="form-control" placeholder="填写类别个数" type="text" autofocus style="width: 220px;display: inline">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button id="modalsubmit" type="button" class="btn btn-primary" data-dismiss="modal">提交更改</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal -->
            </div>

        </div>
    </div>
</div>

<script src="js/jquery-3.3.1.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/bootstrap-table.js"></script>
<script src="js/bootstrap-table-zh-CN.js"></script>
<script src="js/bootstrap-select.js"></script>
<script src="js/common.js"></script>
<script src="js/echarts.min.js"></script>
<script src="js/ecStat.js"></script>
<script type="text/javascript">

    var myChart = echarts.init(document.getElementById('map'));
    var data = [
        [3.275154, 2.957587],
        [-3.344465, 2.603513],
        [0.355083, -3.376585],
        [1.852435, 3.547351],
        [-2.078973, 2.552013],
        [-0.993756, -0.884433],
        [2.682252, 4.007573],
        [-3.087776, 2.878713],
        [-1.565978, -1.256985],
        [2.441611, 0.444826],
        [-0.659487, 3.111284],
        [-0.459601, -2.618005],
        [2.17768, 2.387793],
        [-2.920969, 2.917485],
        [-0.028814, -4.168078],
        [3.625746, 2.119041],
        [-3.912363, 1.325108],
        [-0.551694, -2.814223],
        [2.855808, 3.483301],
        [-3.594448, 2.856651],
        [0.421993, -2.372646],
        [1.650821, 3.407572],
        [-2.082902, 3.384412],
        [-0.718809, -2.492514],
        [4.513623, 3.841029],
        [-4.822011, 4.607049],
        [-0.656297, -1.449872],
        [1.919901, 4.439368],
        [-3.287749, 3.918836],
        [-1.576936, -2.977622],
        [3.598143, 1.97597],
        [-3.977329, 4.900932],
        [-1.79108, -2.184517],
        [3.914654, 3.559303],
        [-1.910108, 4.166946],
        [-1.226597, -3.317889],
        [1.148946, 3.345138],
        [-2.113864, 3.548172],
        [0.845762, -3.589788],
        [2.629062, 3.535831],
        [-1.640717, 2.990517],
        [-1.881012, -2.485405],
        [4.606999, 3.510312],
        [-4.366462, 4.023316],
        [0.765015, -3.00127],
        [3.121904, 2.173988],
        [-4.025139, 4.65231],
        [-0.559558, -3.840539],
        [4.376754, 4.863579],
        [-1.874308, 4.032237],
        [-0.089337, -3.026809],
        [3.997787, 2.518662],
        [-3.082978, 2.884822],
        [0.845235, -3.454465],
        [1.327224, 3.358778],
        [-2.889949, 3.596178],
        [-0.966018, -2.839827],
        [2.960769, 3.079555],
        [-3.275518, 1.577068]
    ];

    var clusterNumber = 6;
    // See https://github.com/ecomfe/echarts-stat
    var step = ecStat.clustering.hierarchicalKMeans(data, clusterNumber, true);
    var result;

    option = {
        timeline: {
            top: 'center',
            right: 35,
            height: 300,
            width: 10,
            inverse: true,
            playInterval: 2500,
            symbol: 'none',
            orient: 'vertical',
            axisType: 'category',
            autoPlay: true,
            label: {
                normal: {
                    show: false
                }
            },
            data: []
        },
        baseOption: {
            title: {
                text: '聚类过程演示',
                subtext: '二维处理',
                left: 'center'
            },
            xAxis: {
                type: 'value'
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                type: 'scatter'
            }]
        },
        options: []
    };

    for (var i = 0; !(result = step.next()).isEnd; i++) {

        option.options.push(getOption(result, clusterNumber));
        option.timeline.data.push(i + '');

    }

    function getOption(result, k) {
        var clusterAssment = result.clusterAssment;
        var centroids = result.centroids;
        var ptsInCluster = result.pointsInCluster;
        var color = ['#c23531', '#2f4554', '#61a0a8', '#d48265', '#91c7ae', '#749f83', '#ca8622', '#bda29a', '#6e7074', '#546570', '#c4ccd3'];
        var series = [];
        for (i = 0; i < k; i++) {
            series.push({
                name: 'scatter' + i,
                type: 'scatter',
                animation: false,
                data: ptsInCluster[i],
                markPoint: {
                    symbolSize: 29,
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                return Math.round(params.data.coord[0] * 100) / 100 + '  ' +
                                    Math.round(params.data.coord[1] * 100) / 100 + ' ';
                            },
                            textStyle: {
                                color: '#000'
                            }
                        }
                    },
                    itemStyle: {
                        normal: {
                            opacity: 0.7
                        }
                    },
                    data: [{
                        coord: centroids[i]
                    }]
                }
            });
        }

        return {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            series: series,
            color: color
        };
    }
    myChart.setOption(option);

    var table_structure=[];
    var current_table=[];

    $("#divtable").empty();
    $("#divtable").append($("<div id=\"toolbar\">\n" +
        "                            <button id=\"button\" class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#myModal\">自定义聚类分析</button>\n" +
        "                        </div>\n" +
        "                        <table id=\"realTime_Table\">\n" +
        "                            <thead id=\"thead\"><th>类簇（表model）</th><th>中心点向量（特征列：device_type_id,manufacturer_id）</th></thead>\n" +
        "                            <tbody id=\"tbody\"></tbody>\n" +
        "                        </table>"));
    $.get("http://39.104.186.210:8092/api/mining/k-means?sourceTable=model&featureColumns=[\"device_type_id\",\"manufacturer_id\"]&host=172.24.32.169&user=root&passwd=root&dbname=BUPT_IOT&port=3306&n_clusters=6",function (data) {
        for (var i=0; i<data.cluster_centers.length; i++) {
            $tr = $("<tr></tr>");
            $td1 = $("<td>第"+(i+1)+"个</td>");
            $td2 = $("<td>("+data.cluster_centers[i]+")</td>");
            $tr.append($td1);
            $tr.append($td2);
            $("#tbody").append($tr);
        }
        $("#realTime_Table").bootstrapTable({
            search: true,
            pagination: true,
            pageSize: 10,
            pageList: [5, 10, 15, 20, 50, 100],
            locale: "zh-CN",
            striped: true,
            showColumns: true,
            sortable: true,
            sortName: "time",
            toolbar: "#toolbar"
        });
    });

    $("#modalsubmit").click(
        function () {
            var a = $("#modal1").val();
            if (a == "") {
                alert("必须先选择源表");
            }else {
                var b = [];
                $("#div2").find("input[type=checkbox]:checked").each(
                    function () {
                        b.push('"'+$(this).val()+'"');
                    }
                );
                $("#divtable").empty();
                $("#divtable").append($("<div id=\"toolbar\">\n" +
                    "                            <button id=\"button\" class=\"btn btn-default\" data-toggle=\"modal\" data-target=\"#myModal\">自定义聚类分析</button>\n" +
                    "                        </div>\n" +
                    "                        <table id=\"realTime_Table\">\n" +
                    "                            <thead id=\"thead\"><th>类簇（表"+a+"）</th><th>中心点向量（特征列："+b+"）</th></thead>\n" +
                    "                            <tbody id=\"tbody\"></tbody>\n" +
                    "                        </table>"));
                var c = $("#modal3").val();
                $.get("http://39.104.186.210:8092/api/mining/k-means?sourceTable="+a+"&featureColumns=["+b+"]&host=172.24.32.169&user=root&passwd=root&dbname=BUPT_IOT&port=3306&n_clusters="+c,function (data) {
                    for (var i=0; i<data.cluster_centers.length; i++) {
                        $tr = $("<tr></tr>");
                        $td1 = $("<td>第"+(i+1)+"个</td>");
                        $td2 = $("<td>("+data.cluster_centers[i]+")</td>");
                        $tr.append($td1);
                        $tr.append($td2);
                        $("#tbody").append($tr);
                    }
                    $("#realTime_Table").bootstrapTable({
                        search: true,
                        pagination: true,
                        pageSize: 10,
                        pageList: [5, 10, 15, 20, 50, 100],
                        locale: "zh-CN",
                        striped: true,
                        showColumns: true,
                        sortable: true,
                        sortName: "time",
                        toolbar: "#toolbar"
                    });
                });
            }
        }
    );

    $.get("http://39.104.186.210:8092/api/etl/table-struct",function (data) {
        table_structure = data;
    });
    
    $("#button").click(
        function () {
            $("#div2").remove();
            $("#div1").remove();
            $div1 = $("<div id=\"div1\">源表：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id=\"modal1\" onchange='tableChange()' class=\"selectpicker\" data-live-search=\"true\" data-live-search-placeholder=\"选择源表\" title=\"选择源表\"></select><br><br></div>");
            $("#divmodal").prepend($div1);
            $select = $("#modal1");
            for (var i=0; i<table_structure.length; i++) {
                $option = $("<option>"+table_structure[i].table_name+"</option>");
                $select.append($option);
            }
            $select.selectpicker("refresh");
        }
    );

    function tableChange() {
        var tableName = $("#modal1").val();
        $("#div2").remove();
        for (var i=0; i<table_structure.length; i++) {
            if (table_structure[i].table_name == tableName) {
                current_table = table_structure[i].columns;
            }
        }
        $div2 = $("<div id='div2'>特征列：</div>");
        for (var j=current_table.length-1; j>=0; j--) {
            $checkbox1 = $("<label style='margin-left: 4%'><input class='merge' value="+current_table[j]+" type=\"checkbox\"/>&nbsp;"+current_table[j]+" </label> ");
            $checkbox2 = $("<label style='margin-left: 4%'><input class='merge' value="+current_table[j]+" type=\"checkbox\"/>&nbsp;"+current_table[j]+" </label> ");
            $div2.append($checkbox1);
        }
        $div2.append($("<br><br>"));
        $("#div1").after($div2);
    }

    function online() {
        window.open("http://39.104.186.210:8888");
    }

    function result2() {
        window.open("pre.html");
    }

</script>
</body>
</html>